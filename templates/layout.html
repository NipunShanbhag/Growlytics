<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Growlytics</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,400italic,600,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Recursive:wght@500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Damion" rel="stylesheet">

  <!-- CSS -->
  <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/font-awesome.min.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/templatemo-style.css') }}" rel="stylesheet">

  <!-- Favicon -->
  <link rel="shortcut icon" href="{{ url_for('static', filename='img/Favicon.png') }}" type="image/x-icon" />

  <style>
    body {
      background-color: #f2f2f2;
      font-family: 'Open Sans', sans-serif;
    }

    /* Header hover effects */
    .tm-nav ul li a {
      position: relative;
      transition: color 0.3s ease;
    }

    .tm-nav ul li a:hover {
      color: #c79c60;
    }

    .tm-nav ul li a::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -6px;
      height: 2px;
      background: #c79c60;
      transform: scaleX(0);
      transform-origin: center;
      transition: transform 0.2s ease;
    }

    .tm-nav ul li a:hover::after,
    .tm-nav ul li a.active::after {
      transform: scaleX(1);
    }

    .tm-site-name a:hover {
      color: #c79c60 !important;
    }

    /* Weather Widget Styles */
    .weather-widget-compact {
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 320px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      border-radius: 16px;
      padding: 20px;
      color: white;
      font-family: 'Arial', sans-serif;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .weather-widget-compact:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }

    .weather-widget-compact.collapsed {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      padding: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .weather-content {
      display: block;
    }

    .weather-widget-compact.collapsed .weather-content {
      display: none !important;
    }

    .weather-widget-compact.collapsed .weather-toggle {
      display: flex !important;
      width: 100%;
      height: 100%;
    }

    .weather-header-compact {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .weather-location-compact {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }

    .weather-close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: background 0.2s ease;
    }

    .weather-close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .weather-current-compact {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .weather-temp-compact {
      font-size: 36px;
      font-weight: 300;
    }

    .weather-desc-compact {
      font-size: 13px;
      opacity: 0.9;
      text-transform: capitalize;
      margin-top: 5px;
    }

    .weather-icon-compact {
      width: 60px;
      height: 60px;
      filter: drop-shadow(0 0 8px rgba(255,255,255,0.3));
    }

    .weather-details-compact {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .weather-detail-compact {
      display: flex;
      flex-direction: column;
      padding: 10px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      font-size: 12px;
    }

    .weather-detail-label {
      opacity: 0.8;
      margin-bottom: 4px;
    }

    .weather-detail-value {
      font-size: 16px;
      font-weight: 600;
    }

    .weather-insight-compact {
      background: rgba(76, 175, 80, 0.25);
      border: 1px solid rgba(76, 175, 80, 0.4);
      border-radius: 8px;
      padding: 12px;
      font-size: 12px;
      line-height: 1.4;
    }

    .weather-update-time {
      font-size: 11px;
      opacity: 0.7;
      text-align: center;
      margin-top: 10px;
    }

    .weather-toggle {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .weather-loading {
      text-align: center;
      padding: 20px;
    }

    .weather-error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid rgba(244, 67, 54, 0.4);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      font-size: 12px;
    }

    /* Chatbot Styles */
    .chatbot-trigger {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
      transition: all 0.3s ease;
      z-index: 1001;
      border: none;
    }

    .chatbot-trigger:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 25px rgba(76, 175, 80, 0.6);
    }

    .chatbot-trigger svg {
      width: 28px;
      height: 28px;
      fill: white;
    }

    .chatbot-widget {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 380px;
      height: 500px;
      background: #1a1a1a;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 1000;
      border: 1px solid #333;
    }

    .chatbot-widget.active {
      display: flex;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chatbot-header {
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      padding: 20px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chatbot-header h3 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }

    .chatbot-header .close-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 20px;
      padding: 5px;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chatbot-header .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #1a1a1a;
    }

    .message {
      margin-bottom: 15px;
      display: flex;
      align-items: flex-end;
    }

    .message.bot {
      justify-content: flex-start;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message-content {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .message.bot .message-content {
      background: #2d2d2d;
      color: #e0e0e0;
      border-bottom-left-radius: 6px;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      color: white;
      border-bottom-right-radius: 6px;
    }

    .chat-input-area {
      padding: 20px;
      background: #1a1a1a;
      border-top: 1px solid #333;
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #333;
      border-radius: 25px;
      background: #2d2d2d;
      color: #e0e0e0;
      font-size: 14px;
      outline: none;
      resize: none;
      font-family: inherit;
    }

    .chat-input:focus {
      border-color: #4CAF50;
    }

    .send-btn {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .send-btn:hover:not(:disabled) {
      transform: scale(1.05);
    }

    .send-btn svg {
      width: 20px;
      height: 20px;
      fill: white;
    }

    @media (max-width: 768px) {
      .weather-widget-compact {
        left: 15px;
        bottom: 15px;
        width: 280px;
      }

      .chatbot-widget {
        width: calc(100vw - 20px);
        height: calc(100vh - 120px);
        right: 10px;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="tm-top-header">
    <div class="container">
      <div class="row">
        <div class="tm-top-header-inner">
          <div class="tm-logo-container">
            <h1 class="tm-site-name tm-handwriting-font" style="font-style: italic;">
              <a href="{{ url_for('index') }}" style="color: inherit; text-decoration: none;">Growlytics</a>
            </h1>
          </div>
          <div class="mobile-menu-icon">
            <i class="fa fa-bars"></i>
          </div>
          <nav class="tm-nav">
            <ul>
              {% block nav %}{% endblock %}
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  {% block body %}{% endblock %}

  <!-- Weather Widget -->
  <div class="weather-widget-compact" id="weather-widget">
    <div class="weather-loading" id="weather-loading">Loading weather...</div>
    <div class="weather-toggle" id="weather-toggle" onclick="toggleWeather()">
      <span>☀️</span>
    </div>
  </div>

  <!-- Chatbot Trigger -->
  <button class="chatbot-trigger" id="chatbot-trigger">
    <svg viewBox="0 0 24 24">
      <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
    </svg>
  </button>

  <!-- Chatbot Widget -->
  <div class="chatbot-widget" id="chatbot-widget">
    <div class="chatbot-header">
      <h3>Growlytics AI Assistant</h3>
      <button class="close-btn" id="close-chatbot">×</button>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="message bot">
        <div class="message-content">
          Hello! I'm your Growlytics AI assistant. I can help with crops, fertilizers, weather advice, and farming solutions. How can I assist you today?
        </div>
      </div>
    </div>
    <div class="chat-input-area">
      <textarea class="chat-input" id="chat-input" placeholder="Ask about farming..." rows="1"></textarea>
      <button class="send-btn" id="send-btn">
        <svg viewBox="0 0 24 24">
          <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- JS -->
  <script src="{{ url_for('static', filename='js/jquery-1.11.2.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/templatemo-script.js') }}"></script>

  <script>
    // Weather Widget
    class WeatherWidget {
      constructor() {
        this.apiKey = '9eaf85596fd5e44fee5e503381dc4b7d';
        this.city = 'Mumbai';
        this.isCollapsed = false;
        this.init();
      }

      async init() {
        await this.loadWeather();
        setInterval(() => this.loadWeather(), 900000); // Update every 15 min
      }

      async loadWeather() {
        try {
          const url = `https://api.openweathermap.org/data/2.5/weather?q=${this.city}&appid=${this.apiKey}&units=metric`;
          const response = await fetch(url);
          const data = await response.json();
          
          if (response.ok) {
            this.render(data);
          } else {
            this.showError('Unable to load weather');
          }
        } catch (error) {
          this.showError('Weather unavailable');
        }
      }

      render(data) {
        const advice = this.getAdvice(data);
        const widget = document.getElementById('weather-widget');
        
        widget.innerHTML = `
          <div class="weather-content" id="weather-content-main">
            <div class="weather-header-compact">
              <div class="weather-location-compact">
                <span>📍 ${data.name}</span>
              </div>
              <button class="weather-close-btn" onclick="weatherWidget.toggleCollapse()">−</button>
            </div>
            
            <div class="weather-current-compact">
              <div>
                <div class="weather-temp-compact">${Math.round(data.main.temp)}°C</div>
                <div class="weather-desc-compact">${data.weather[0].description}</div>
              </div>
              <img class="weather-icon-compact" 
                   src="https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png" 
                   alt="weather">
            </div>
            
            <div class="weather-details-compact">
              <div class="weather-detail-compact">
                <div class="weather-detail-label">Humidity</div>
                <div class="weather-detail-value">${data.main.humidity}%</div>
              </div>
              <div class="weather-detail-compact">
                <div class="weather-detail-label">Wind</div>
                <div class="weather-detail-value">${(data.wind.speed * 3.6).toFixed(0)} km/h</div>
              </div>
            </div>
            
            <div class="weather-insight-compact">
              🌱 ${advice}
            </div>
            
            <div class="weather-update-time">
              Updated: ${new Date().toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}
            </div>
          </div>
          
          <div class="weather-toggle" id="weather-toggle-icon" onclick="weatherWidget.toggleCollapse()">
            <span>☀️</span>
          </div>
        `;
      }

      toggleCollapse() {
        this.isCollapsed = !this.isCollapsed;
        const widget = document.getElementById('weather-widget');
        if (this.isCollapsed) {
          widget.classList.add('collapsed');
        } else {
          widget.classList.remove('collapsed');
        }
      }

      getAdvice(data) {
        const temp = data.main.temp;
        const condition = data.weather[0].main.toLowerCase();
        
        if (condition.includes('rain')) {
          return "Good for irrigation. Avoid pesticide spraying.";
        } else if (temp > 35) {
          return "High heat! Increase irrigation and use shade nets.";
        } else if (temp < 15) {
          return "Cool weather ideal for rabi crops.";
        } else {
          return "Perfect conditions for farming activities!";
        }
      }

      showError(msg) {
        document.getElementById('weather-widget').innerHTML = 
          `<div class="weather-error">${msg}</div>`;
      }
    }

    function toggleWeather() {
      const widget = document.getElementById('weather-widget');
      widget.classList.toggle('collapsed');
    }

    // Chatbot
    class Chatbot {
      constructor() {
        this.isOpen = false;
        this.init();
      }

      init() {
        document.getElementById('chatbot-trigger').onclick = () => this.toggle();
        document.getElementById('close-chatbot').onclick = () => this.close();
        document.getElementById('send-btn').onclick = () => this.send();
        document.getElementById('chat-input').onkeypress = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.send();
          }
        };
      }

      toggle() {
        this.isOpen = !this.isOpen;
        document.getElementById('chatbot-widget').classList.toggle('active', this.isOpen);
        if (this.isOpen) document.getElementById('chat-input').focus();
      }

      close() {
        this.isOpen = false;
        document.getElementById('chatbot-widget').classList.remove('active');
      }

      send() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if (!msg) return;

        this.addMsg(msg, 'user');
        input.value = '';
        
        setTimeout(() => {
          const reply = this.getReply(msg);
          this.addMsg(reply, 'bot');
        }, 500);
      }

      addMsg(text, type) {
        const container = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerHTML = `<div class="message-content">${text}</div>`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      }

      getReply(msg) {
        const lower = msg.toLowerCase();
        if (lower.includes('crop')) {
          return "For crop selection, consider soil type, climate, and market demand. Popular options include rice, wheat, and cotton depending on your region.";
        } else if (lower.includes('fertilizer')) {
          return "Start with soil testing to determine NPK needs. Apply fertilizers based on crop growth stage for optimal results.";
        } else if (lower.includes('pest')) {
          return "Use Integrated Pest Management: combine biological controls, cultural practices, and selective pesticides when necessary.";
        } else {
          return "I can help with crop selection, fertilizer guidance, pest control, and weather-based farming advice. What specific challenge are you facing?";
        }
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      new WeatherWidget();
      new Chatbot();
    });
  </script>
</body>
</html>